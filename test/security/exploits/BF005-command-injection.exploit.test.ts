/**
 * BF005: Command Injection - Exploit Tests
 *
 * Tests that query expressions are sanitized to prevent injection attacks.
 */

import { describe, it } from 'node:test';
import assert from 'node:assert';
import { QuerySanitizer } from '../../../dist/cli/query-sanitizer.js';
import { SecurityError } from '../../../dist/errors/index.js';

describe('BF005: Command Injection - Exploit Tests', () => {
  describe('Dangerous Pattern Blocking', () => {
    it('should block require() in queries', () => {
      const malicious = '$[?(@.x && require("child_process"))]';

      assert.throws(
        () => QuerySanitizer.sanitize(malicious),
        SecurityError,
        'Should block require()'
      );
    });

    it('should block eval() in queries', () => {
      const malicious = '$[?(@.x && eval("code"))]';

      assert.throws(
        () => QuerySanitizer.sanitize(malicious),
        SecurityError,
        'Should block eval()'
      );
    });

    it('should block exec()', () => {
      const malicious = '$[?(@.x && exec("ls"))]';

      assert.throws(
        () => QuerySanitizer.sanitize(malicious),
        SecurityError,
        'Should block exec()'
      );
    });

    it('should block import()', () => {
      const malicious = 'import("fs").then(...)';

      assert.throws(
        () => QuerySanitizer.sanitize(malicious),
        SecurityError,
        'Should block import()'
      );
    });

    it('should block Function() constructor', () => {
      const malicious = 'Function("return 1")()';

      assert.throws(
        () => QuerySanitizer.sanitize(malicious),
        SecurityError,
        'Should block Function()'
      );
    });

    it('should block process.env', () => {
      const malicious = '$[?(@.key == process.env.SECRET)]';

      assert.throws(
        () => QuerySanitizer.sanitize(malicious),
        SecurityError,
        'Should block process.env'
      );
    });

    it('should block child_process', () => {
      const malicious = 'child_process.spawn("ls")';

      assert.throws(
        () => QuerySanitizer.sanitize(malicious),
        SecurityError,
        'Should block child_process'
      );
    });

    it('should block fs. patterns', () => {
      const malicious = 'fs.readFileSync("/etc/passwd")';

      assert.throws(
        () => QuerySanitizer.sanitize(malicious),
        SecurityError,
        'Should block fs.'
      );
    });

    it('should block directory traversal', () => {
      const malicious = '$[?(@.path contains "../../../etc/passwd")]';

      assert.throws(
        () => QuerySanitizer.sanitize(malicious),
        SecurityError,
        'Should block ../ sequences'
      );
    });
  });

  describe('ANSI Escape Codes', () => {
    it('should strip ANSI escape codes', () => {
      const withAnsi = '\x1b[H\x1b[2J$[*]';

      const sanitized = QuerySanitizer.sanitize(withAnsi);

      // ANSI codes should be stripped
      assert.ok(!sanitized.includes('\x1b'));
      assert.ok(sanitized.includes('$[*]'));
    });

    it('should strip color codes', () => {
      const withColor = '\x1b[31mRED\x1b[0m$[*]';

      const sanitized = QuerySanitizer.sanitize(withColor);

      assert.ok(!sanitized.includes('\x1b'));
    });
  });

  describe('Null Bytes', () => {
    it('should reject null bytes', () => {
      const malicious = '$[*]\0/etc/passwd';

      assert.throws(
        () => QuerySanitizer.sanitize(malicious),
        SecurityError,
        'Should block null bytes'
      );
    });
  });

  describe('Length Limits', () => {
    it('should enforce maximum length', () => {
      const longQuery = '$[*]'.repeat(500); // 2000 chars

      assert.throws(
        () => QuerySanitizer.sanitize(longQuery, { maxLength: 1000 }),
        SecurityError,
        'Should enforce length limit'
      );
    });

    it('should allow queries under limit', () => {
      const okQuery = '$[?(@.age > 18 && @.active)]';

      assert.doesNotThrow(
        () => QuerySanitizer.sanitize(okQuery, { maxLength: 1000 }),
        'Should allow queries under limit'
      );
    });
  });

  describe('Nesting Depth Limits', () => {
    it('should enforce nesting depth', () => {
      const deepQuery = '['.repeat(150) + ']'.repeat(150);

      assert.throws(
        () => QuerySanitizer.sanitize(deepQuery, { maxDepth: 100 }),
        SecurityError,
        'Should enforce nesting depth'
      );
    });

    it('should allow reasonable nesting', () => {
      const okQuery = '$[0].data[1].items[2]';

      assert.doesNotThrow(
        () => QuerySanitizer.sanitize(okQuery, { maxDepth: 100 }),
        'Should allow reasonable nesting'
      );
    });
  });

  describe('Legitimate Queries', () => {
    it('should allow all legitimate query patterns', () => {
      const legitimate = [
        '$[*]',
        '$.users[?(@.age > 18)]',
        '$.products[?(@.price < 100 && @.inStock)]',
        '$..email',
        'users[0].name',
        'config.database.host',
        '$[?(@.role == "admin" || @.role == "moderator")]',
        '$.items[?(@.tags.length > 0)]',
      ];

      for (const query of legitimate) {
        assert.doesNotThrow(
          () => QuerySanitizer.sanitize(query),
          `Should allow: ${query}`
        );
      }
    });

    it('should preserve query content', () => {
      const query = '$.users[?(@.age > 25)]';

      const sanitized = QuerySanitizer.sanitize(query);

      assert.strictEqual(sanitized, query);
    });
  });

  describe('Logging Sanitization', () => {
    it('should truncate long queries', () => {
      const longQuery = 'x'.repeat(200);

      const sanitized = QuerySanitizer.sanitizeForLogging(longQuery);

      assert.ok(sanitized.length <= 100);
      assert.ok(sanitized.endsWith('...'));
    });

    it('should remove newlines', () => {
      const multiline = '$[*]\n$[*]';

      const sanitized = QuerySanitizer.sanitizeForLogging(multiline);

      assert.ok(!sanitized.includes('\n'));
    });

    it('should strip ANSI codes', () => {
      const withAnsi = '\x1b[31m$[*]\x1b[0m';

      const sanitized = QuerySanitizer.sanitizeForLogging(withAnsi);

      assert.ok(!sanitized.includes('\x1b'));
    });
  });

  describe('Type Validation', () => {
    it('should reject non-string queries', () => {
      assert.throws(
        () => QuerySanitizer.sanitize(null as any),
        SecurityError,
        'Should reject null'
      );

      assert.throws(
        () => QuerySanitizer.sanitize(undefined as any),
        SecurityError,
        'Should reject undefined'
      );

      assert.throws(
        () => QuerySanitizer.sanitize(123 as any),
        SecurityError,
        'Should reject number'
      );
    });
  });
});
